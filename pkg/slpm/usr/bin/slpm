#!/usr/bin/env bash
# SLPM - SoloLinux Package Manager (Colourised)

# --- SoloLinux enforced /etc/os-release contents ---
SLPM_OS_RELEASE_ENFORCED='NAME="SoloLinux"
PRETTY_NAME="SoloLinux"
ID=sololinux
ID_LIKE=arch
BUILD_ID=rolling
ANSI_COLOR="0;38;2;37;104;151"
HOME_URL="https://archlinux.org/"
DOCUMENTATION_URL="https://wiki.archlinux.org/"
SUPPORT_URL="https://bbs.archlinux.org/"
BUG_REPORT_URL="https://gitlab.archlinux.org/groups/archlinux/-/issues"
PRIVACY_POLICY_URL="https://terms.archlinux.org/docs/privacy-policy/"
LOGO=archlinux-logo'

# --- COLOURS ---
SL_COLOUR="\e[38;2;37;104;151m"
SL_BOLD="\e[1m"
SL_RESET="\e[0m"

# Colour helpers
msg() {
  echo -e "${SL_COLOUR}${SL_BOLD}SLPM:${SL_RESET} $*"
}

success() {
  echo -e "${SL_COLOUR}✔${SL_RESET} $*"
}

error() {
  echo -e "${SL_COLOUR}${SL_BOLD}✘ ERROR:${SL_RESET} $*" >&2
}

# Logging setup
set -euo pipefail
IFS=$'\n\t'

SLPM_BIN="$(readlink -f "$0")"
BACKUP_DIR="/var/lib/slpm"
LOG_DIR="/var/log/slpm"
LOG_FILE="$LOG_DIR/slpm-$(date +%Y%m%d-%H%M%S).log"
OS_RELEASE="/etc/os-release"
PROTECT_FLAG="$BACKUP_DIR/.protect-os-release"

require_root() {
  if [[ $EUID -ne 0 ]]; then
    error "Root privileges required. Re-run with sudo."
    exit 1
  fi
}

log() {
  mkdir -p "$LOG_DIR"
  echo "[$(date +'%Y-%m-%d %H:%M:%S')] $*" >> "$LOG_FILE"
}

ensure_dirs() {
  mkdir -p "$BACKUP_DIR"
  mkdir -p "$LOG_DIR"
}

# --- ENFORCE /etc/os-release ---
enforce_os_release() {
  printf "%s" "$SLPM_OS_RELEASE_ENFORCED" > "$OS_RELEASE"
  msg "Enforced SoloLinux identity in /etc/os-release"
}

# --- init ---
init() {
  require_root
  ensure_dirs
  enforce_os_release
  msg "SLPM initialised."
}

# --- pacman wrappers ---
cmd_install() {
  require_root
  msg "Installing: $*"
  log "install $*"

  pacman -S --noconfirm "$@"
  enforce_os_release
}

cmd_remove() {
  require_root
  msg "Removing: $*"
  log "remove $*"

  pacman -R "$@"
  enforce_os_release
}

cmd_upgrade() {
  require_root
  msg "Upgrading system..."
  log "upgrade"

  pacman -Syu --noconfirm
  enforce_os_release
}

cmd_search() {
  msg "Searching for: $*"
  pacman -Ss "$@"
}

cmd_info() {
  msg "Package info: $*"
  pacman -Si "$@"
}

cmd_list() {
  msg "Explicitly installed packages:"
  pacman -Qe
}

cmd_backup() {
  require_root
  msg "Backing up: $*"
  for file in "$@"; do
    cp -a "$file" "$BACKUP_DIR/"
    success "Backed up $file"
  done
}

cmd_restore() {
  require_root
  msg "Restoring: $*"
  for file in "$@"; do
    cp -a "$BACKUP_DIR/$(basename "$file")" "$file"
    success "Restored $file"
  done
}

cmd_protect() {
  require_root
  case "$1" in
    on)
      touch "$PROTECT_FLAG"
      msg "Protection enabled: /etc/os-release will always be enforced."
      ;;
    off)
      rm -f "$PROTECT_FLAG"
      msg "Protection disabled."
      ;;
    *)
      error "Usage: slpm protect {on|off}"
      ;;
  esac
}

cmd_config() {
  msg "SLPM Configuration"
  echo "Backup dir: $BACKUP_DIR"
  echo "Log dir:    $LOG_DIR"
  echo "Protect:    $( [[ -f $PROTECT_FLAG ]] && echo ON || echo OFF )"
}

show_help() {
  echo -e "${SL_COLOUR}${SL_BOLD}SLPM - SoloLinux Package Manager${SL_RESET}"
  echo "  init               Initialise SLPM"
  echo "  install|i PKG      Install package(s)"
  echo "  remove|r PKG       Remove package(s)"
  echo "  upgrade|u          System upgrade"
  echo "  search|s QUERY     Search packages"
  echo "  info PKG           Show package info"
  echo "  list               List user-installed packages"
  echo "  backup FILE        Backup config files"
  echo "  restore FILE       Restore backed files"
  echo "  protect on|off     Toggle os-release protection"
  echo "  config             Show configuration"
  echo "  help               This help"
}

# --- DISPATCHER ---
if [[ $# -lt 1 ]]; then
  show_help
  exit 0
fi

cmd="$1"
shift || true

case "$cmd" in
  init) init "$@" ;;
  install|i) cmd_install "$@" ;;
  remove|r) cmd_remove "$@" ;;
  upgrade|u) cmd_upgrade "$@" ;;
  search|s) cmd_search "$@" ;;
  info) cmd_info "$@" ;;
  list) cmd_list "$@" ;;
  backup) cmd_backup "$@" ;;
  restore) cmd_restore "$@" ;;
  protect) cmd_protect "$@" ;;
  config) cmd_config "$@" ;;
  help|--help|-h) show_help ;;
  *)
    error "Unknown command: $cmd"
    show_help
    exit 2
    ;;
esac


# #!/usr/bin/env bash
# # SLPM - SoloLinux Package Manager
#
# set -euo pipefail
# IFS=$'\n\t'
#
# # --- SoloLinux enforced /etc/os-release contents ---
# SLPM_OS_RELEASE_ENFORCED='NAME="SoloLinux"
# PRETTY_NAME="SoloLinux"
# ID=sololinux
# ID_LIKE=arch
# BUILD_ID=rolling
# ANSI_COLOR="0;38;2;37;104;151"
# HOME_URL="https://archlinux.org/"
# DOCUMENTATION_URL="https://wiki.archlinux.org/"
# SUPPORT_URL="https://bbs.archlinux.org/"
# BUG_REPORT_URL="https://gitlab.archlinux.org/groups/archlinux/-/issues"
# PRIVACY_POLICY_URL="https://terms.archlinux.org/docs/privacy-policy/"
# LOGO=archlinux-logo'
#
# # --- Paths ---
# BACKUP_DIR="/var/lib/slpm"
# LOG_DIR="/var/log/slpm"
# OS_RELEASE="/etc/os-release"
# LOG_FILE="$LOG_DIR/slpm-$(date +%Y%m%d-%H%M%S).log"
#
# # --- Helpers ---
# require_root() {
#     if [[ $EUID -ne 0 ]]; then
#         echo "SLPM: root privileges required. Use sudo." >&2
#         exit 1
#     fi
# }
#
# log() {
#     mkdir -p "$LOG_DIR"
#     echo "[$(date +'%Y-%m-%d %H:%M:%S')] $*" | tee -a "$LOG_FILE"
# }
#
# ensure_dirs() {
#     mkdir -p "$BACKUP_DIR" "$LOG_DIR"
# }
#
# # --- Enforce SoloLinux identity ---
# enforce_os_release() {
#     log "Enforcing SoloLinux identity in /etc/os-release"
#     printf "%s" "$SLPM_OS_RELEASE_ENFORCED" > "$OS_RELEASE"
# }
#
# # --- Commands ---
# cmd_install() {
#     require_root
#     log "Installing: $*"
#     pacman -S --noconfirm "$@" | tee -a "$LOG_FILE"
#     enforce_os_release
# }
#
# cmd_remove() {
#     require_root
#     log "Removing: $*"
#     pacman -R --noconfirm "$@" | tee -a "$LOG_FILE"
#     enforce_os_release
# }
#
# cmd_upgrade() {
#     require_root
#     log "System upgrade"
#     pacman -Syu --noconfirm | tee -a "$LOG_FILE"
#     enforce_os_release
# }
#
# cmd_search() {
#     log "Searching: $*"
#     pacman -Ss "$@" | tee -a "$LOG_FILE"
# }
#
# cmd_info() {
#     log "Info: $*"
#     pacman -Si "$@" | tee -a "$LOG_FILE"
# }
#
# cmd_list() {
#     log "Listing explicitly installed packages"
#     pacman -Qe | tee -a "$LOG_FILE"
# }
#
# cmd_backup() {
#     require_root
#     ensure_dirs
#     for file in "$@"; do
#         if [[ -f "$file" ]]; then
#             cp "$file" "$BACKUP_DIR/"
#             log "Backed up $file to $BACKUP_DIR"
#         else
#             log "Warning: $file not found"
#         fi
#     done
# }
#
# cmd_restore() {
#     require_root
#     for file in "$@"; do
#         base=$(basename "$file")
#         if [[ -f "$BACKUP_DIR/$base" ]]; then
#             cp "$BACKUP_DIR/$base" "$file"
#             log "Restored $file"
#         else
#             log "Warning: no backup found for $file"
#         fi
#     done
# }
#
# cmd_config() {
#     echo "SLPM configuration:
#   Enforced os-release: Yes
#   Backup directory: $BACKUP_DIR
#   Log directory: $LOG_DIR"
# }
#
# show_help() {
#     cat <<EOF
# SLPM - SoloLinux Package Manager
#
# Usage: slpm <command> [args]
#
# Commands:
#   install|i PKG...      Install packages
#   remove|r PKG...       Remove packages
#   upgrade|u             Full system upgrade
#   search|s QUERY        Search packages
#   info PKG              Package info
#   list                  List explicitly installed packages
#   backup FILE...        Backup files to SLPM backup dir
#   restore FILE...       Restore files from backup
#   config                Show SLPM config
#   help                  Show this help
#
# SLPM *always* restores SoloLinux identity by enforcing /etc/os-release.
# EOF
# }
#
# # --- Init command ---
# cmd_init() {
#     require_root
#     ensure_dirs
#     enforce_os_release
#     log "SLPM initialized."
# }
#
# # --- Main ---
# if [[ $# -lt 1 ]]; then
#     show_help
#     exit 0
# fi
#
# cmd="$1"; shift || true
#
# case "$cmd" in
#     init) cmd_init "$@" ;;
#     install|i) cmd_install "$@" ;;
#     remove|r) cmd_remove "$@" ;;
#     upgrade|u) cmd_upgrade "$@" ;;
#     search|s) cmd_search "$@" ;;
#     info) cmd_info "$@" ;;
#     list) cmd_list "$@" ;;
#     backup) cmd_backup "$@" ;;
#     restore) cmd_restore "$@" ;;
#     config) cmd_config "$@" ;;
#     help|--help|-h) show_help ;;
#     *)
#         echo "Unknown command: $cmd" >&2
#         show_help
#         exit 1
#         ;;
# esac

